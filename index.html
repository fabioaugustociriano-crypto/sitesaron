<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Painel do Dono - Pedidos</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f6f8fb;color:#222;margin:0;padding:20px}
  .container{max-width:1000px;margin:20px auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(12,30,60,0.06)}
  h1{margin-top:0}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;box-sizing:border-box;margin-bottom:10px}
  button{background:#0b69ff;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  button.danger{background:#e23b3b}
  .flex{display:flex;gap:8px;align-items:center}
  table{width:100%;border-collapse:collapse;margin-top:14px}
  th,td{padding:8px;border-bottom:1px solid #f0f2f7;text-align:left}
  .small{font-size:0.9rem;color:#556}
  .badge{padding:6px 10px;border-radius:8px;font-weight:600;display:inline-block}
  .badge.criado{background:#eef2ff;color:#1e3a8a}
  .badge.emproducao{background:#fff6e6;color:#7a4b00}
  .badge.separado{background:#fff0f6;color:#7a1a4a}
  .badge.entregue{background:#e6f7ed;color:#177a3b}
  .inline{display:inline-block;vertical-align:middle}
  .row{display:flex;gap:12px}
  @media(max-width:800px){ .row{flex-direction:column} }
</style>
</head>
<body>
  <div class="container">
    <h1>Painel do Dono</h1>
    <p class="small">Senha admin (padrão): <code>Batista2025</code>. Você pode alterar dentro do código se quiser.</p>

    <div class="row">
      <div style="flex:1">
        <label><strong>Senha admin</strong></label>
        <input id="adminPass" type="password" placeholder="Senha admin" />
      </div>
      <div style="width:220px;display:flex;align-items:end">
        <button id="btnLoad">Carregar Pedidos</button>
      </div>
    </div>

    <hr/>

    <h3>Criar Pedido</h3>
    <div class="row">
      <div style="flex:1">
        <label>Nome do cliente</label>
        <input id="createName" placeholder="Nome completo" />
      </div>
      <div style="width:240px">
        <label>CPF (somente números)</label>
        <input id="createCpf" placeholder="Ex: 12345678909" />
      </div>
    </div>
    <label>Descrição</label>
    <textarea id="createDesc" rows="2" placeholder="Descrição do pedido"></textarea>
    <div style="display:flex;gap:8px">
      <button id="createBtn">Criar Pedido</button>
      <button id="clearAllBtn" class="danger">Limpar TODOS (apaga todos os pedidos)</button>
    </div>

    <div id="message" class="small" style="margin-top:8px;color:#a00"></div>

    <h3 style="margin-top:18px">Lista de Pedidos</h3>
    <div id="ordersBox"></div>
  </div>

<script>
/* Utils */
function normalizeName(name){
  return (name||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .toLowerCase().replace(/[^a-z0-9]/g,'');
}
function digitsOnly(s){ return (s||'').replace(/\D/g,''); }
function generateCode(name, cpf){
  const n = normalizeName(name);
  const c = digitsOnly(cpf).slice(0,4);
  return (n + c);
}
function loadOrders(){ return JSON.parse(localStorage.getItem('orders_v1')||'[]'); }
function saveOrders(a){ localStorage.setItem('orders_v1', JSON.stringify(a)); }

/* Simple CPF validation */
function validateCPF(cpf){
  const s = digitsOnly(cpf);
  if(s.length !== 11) return false;
  if(/^(\d)\1+$/.test(s)) return false;
  const calc = (arr, pos) => {
    let sum = 0;
    for(let i=0;i<pos;i++) sum += Number(arr[i]) * (pos+1-i);
    let res = (sum * 10) % 11;
    return (res === 10) ? 0 : res;
  };
  const a = s.split('');
  return calc(a,9) === Number(a[9]) && calc(a,10) === Number(a[10]);
}

/* Admin password (simple protection in front-end) */
const ADMIN_PASS = 'Batista2025';

/* Elements */
const msg = document.getElementById('message');
const ordersBox = document.getElementById('ordersBox');

function showMessage(t, ok=true){
  msg.style.color = ok ? '#0a7' : '#a00';
  msg.textContent = t;
  setTimeout(()=>{ msg.textContent=''; }, 4000);
}

/* CRUD */
document.getElementById('createBtn').addEventListener('click', ()=> {
  const pass = document.getElementById('adminPass').value;
  if(pass !== ADMIN_PASS){ showMessage('Senha admin incorreta', false); return; }

  const name = document.getElementById('createName').value.trim();
  const cpf = digitsOnly(document.getElementById('createCpf').value);
  const desc = document.getElementById('createDesc').value.trim();
  if(!name || !cpf){ showMessage('Informe nome e CPF.', false); return; }
  if(!validateCPF(cpf)){ showMessage('CPF inválido. Use 11 dígitos.', false); return; }

  const orders = loadOrders();
  let code = generateCode(name, cpf);
  if(!code){ showMessage('Erro ao gerar código.', false); return; }
  if(orders.some(o=>o.code===code)){
    code = code + Date.now().toString().slice(-4); // evitar colisão
  }
  const now = new Date().toISOString();
  const order = {
    id: Date.now(),
    code, name, cpf, description: desc, status: 'criado',
    createdAt: now, updatedAt: now
  };
  orders.unshift(order);
  saveOrders(orders);
  showMessage('Pedido criado: ' + code, true);
  clearCreateForm();
  renderList();
});

function clearCreateForm(){
  document.getElementById('createName').value='';
  document.getElementById('createCpf').value='';
  document.getElementById('createDesc').value='';
}

document.getElementById('btnLoad').addEventListener('click', ()=> {
  const pass = document.getElementById('adminPass').value;
  if(pass !== ADMIN_PASS){ showMessage('Senha admin incorreta', false); return; }
  renderList();
});

document.getElementById('clearAllBtn').addEventListener('click', ()=> {
  const pass = document.getElementById('adminPass').value;
  if(pass !== ADMIN_PASS){ showMessage('Senha admin incorreta', false); return; }
  if(!confirm('Tem certeza que deseja apagar TODOS os pedidos?')) return;
  localStorage.removeItem('orders_v1');
  renderList();
  showMessage('Todos os pedidos foram apagados.', true);
});

/* Render list with edit controls */
function renderList(){
  const orders = loadOrders();
  if(!orders || orders.length===0){ ordersBox.innerHTML = '<p class="small">Nenhum pedido.</p>'; return; }

  const rows = orders.map(o => `
    <tr data-id="${o.id}">
      <td style="min-width:120px"><strong>${o.code}</strong><div class="small">Criado: ${new Date(o.createdAt).toLocaleString()}</div></td>
      <td style="min-width:180px">
        <input class="editName" value="${escapeHtml(o.name)}" />
        <input class="editCpf" value="${o.cpf}" style="margin-top:6px" />
      </td>
      <td><textarea class="editDesc" rows="2">${escapeHtml(o.description||'')}</textarea></td>
      <td>
        <select class="editStatus">
          <option value="criado" ${o.status==='criado'?'selected':''}>criado</option>
          <option value="em produção" ${o.status==='em produção'?'selected':''}>em produção</option>
          <option value="separado" ${o.status==='separado'?'selected':''}>separado</option>
          <option value="entregue" ${o.status==='entregue'?'selected':''}>entregue</option>
        </select>
        <div class="small" style="margin-top:6px">Atual: ${new Date(o.updatedAt).toLocaleString()}</div>
      </td>
      <td style="min-width:160px">
        <div style="display:flex;gap:6px;flex-direction:column">
          <button class="saveBtn">Salvar</button>
          <button class="copyCodeBtn">Copiar code</button>
          <button class="deleteBtn" style="background:#e23b3b;color:#fff">Excluir</button>
        </div>
      </td>
    </tr>
  `).join('');

  ordersBox.innerHTML = <table><thead><tr><th>Code</th><th>Nome / CPF</th><th>Descrição</th><th>Status</th><th>Ações</th></tr></thead><tbody>${rows}</tbody></table>;

  // bind actions
  document.querySelectorAll('.saveBtn').forEach(btn => btn.addEventListener('click', onSave));
  document.querySelectorAll('.deleteBtn').forEach(btn => btn.addEventListener('click', onDelete));
  document.querySelectorAll('.copyCodeBtn').forEach(btn => btn.addEventListener('click', onCopy));
}

function onSave(ev){
  const pass = document.getElementById('adminPass').value;
  if(pass !== ADMIN_PASS){ showMessage('Senha admin incorreta', false); return; }

  const tr = ev.currentTarget.closest('tr');
  const id = Number(tr.dataset.id);
  const name = tr.querySelector('.editName').value.trim();
  const cpf = digitsOnly(tr.querySelector('.editCpf').value);
  const desc = tr.querySelector('.editDesc').value.trim();
  const status = tr.querySelector('.editStatus').value;

  if(!name || !cpf){ showMessage('Nome e CPF obrigatórios.', false); return; }
  if(!validateCPF(cpf)){ showMessage('CPF inválido (11 dígitos).', false); return; }

  const orders = loadOrders();
  const idx = orders.findIndex(o => o.id === id);
  if(idx === -1){ showMessage('Pedido não encontrado.', false); renderList(); return; }

  // update and regenerate code
  let newCode = generateCode(name, cpf);
  if(orders.some((o,i)=> o.code === newCode && o.id !== id)){
    newCode = newCode + Date.now().toString().slice(-4);
  }

  orders[idx].name = name;
  orders[idx].cpf = cpf;
  orders[idx].description = desc;
  orders[idx].status = status;
  orders[idx].code = newCode;
  orders[idx].updatedAt = new Date().toISOString();
  saveOrders(orders);
  showMessage('Pedido salvo ('+newCode+').', true);
  renderList();
}

function onDelete(ev){
  const pass = document.getElementById('adminPass').value;
  if(pass !== ADMIN_PASS){ showMessage('Senha admin incorreta', false); return; }
  if(!confirm('Excluir este pedido?')) return;
  const tr = ev.currentTarget.closest('tr');
  const id = Number(tr.dataset.id);
  let orders = loadOrders();
  orders = orders.filter(o=>o.id !== id);
  saveOrders(orders);
  showMessage('Pedido excluído.', true);
  renderList();
}

function onCopy(ev){
  const tr = ev.currentTarget.closest('tr');
  const id = Number(tr.dataset.id);
  const orders = loadOrders();
  const o = orders.find(x=>x.id===id);
  if(o){
    navigator.clipboard?.writeText(o.code).then(()=> showMessage('Code copiado: '+o.code,true), ()=> showMessage('Falha ao copiar', false));
  }
}

/* escape to avoid breaking HTML values */
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;'); }

/* Initial render */
renderList();
</script>
</body>
</html>
